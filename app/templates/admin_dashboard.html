<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <style>
      .table-container {
          max-height: 60vh;
          overflow-y: auto;
          padding-bottom: 10px;
      }

      thead th {
          position: sticky;
          top: 0;
          background: #212529;
          color: white;
          z-index: 5;
      }
  </style>
</head>

<body class="bg-light">

<div class="container mt-4">

  <h1 class="mb-3">Welcome, {{ user.name }} (Admin)</h1>

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Doctors</h5>
          <p class="display-6">{{ total_doctors }}</p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Patients</h5>
          <p class="display-6">{{ total_patients }}</p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Appointments</h5>
          <p class="display-6">{{ total_appointments }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Action Buttons -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <a href="{{ url_for('manage_doctors') }}" class="btn btn-primary me-2">Manage Doctors</a>
      <a href="{{ url_for('manage_users') }}" class="btn btn-info me-2">Manage Users</a>
      <a href="{{ url_for('admin_analytics') }}" class="btn btn-warning">View Analytics</a>
    </div>

    <div>
      <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
    </div>
  </div>

  <!-- UPCOMING APPOINTMENTS -->
  <h3 class="mt-4 mb-3 text-success">Upcoming Appointments</h3>

  {% if upcoming_appointments %}
  <div class="table-container mb-4">
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Doctor</th>
          <th>Patient</th>
          <th>Date</th>
          <th>Time</th>
          <th>Status</th>
          <th>Action</th> <!-- KEEP ONLY HERE -->
        </tr>
      </thead>

      <tbody>
        {% for a in upcoming_appointments %}
        <tr>
          <td>{{ a.id }}</td>
          <td>{{ a.doctor.name }}</td>
          <td>{{ a.patient.name }}</td>
          <td>{{ a.date }}</td>
          <td>{{ a.time.strftime('%H:%M') }}</td>

          <td class="status-cell"
              data-date="{{ a.date }}"
              data-time="{{ a.time.strftime('%H:%M') }}"
              data-status="{{ a.status }}">
              <span class="badge bg-info text-dark">Booked</span>
          </td>

          <td>
            <a href="{{ url_for('admin_cancel_appointment', appointment_id=a.id) }}"
               class="btn btn-sm btn-danger"
               onclick="return confirm('Cancel this appointment?');">Cancel</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>

    </table>
  </div>
  {% else %}
    <div class="alert alert-warning">No upcoming appointments.</div>
  {% endif %}

  <!-- ALL APPOINTMENTS -->
  <h3 class="mt-4 mb-3">All Appointments</h3>

  <input id="searchBox" class="form-control mb-3" type="text" placeholder="Search doctor or patient...">

  <div class="table-container">
      <table class="table table-bordered table-striped">

          <thead class="table-dark">
              <tr>
                  <th>ID</th>
                  <th>Doctor</th>
                  <th>Patient</th>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Status</th>
                  <!-- NO ACTION COLUMN HERE -->
              </tr>
          </thead>

          <tbody id="appointmentsTable">
              {% for a in appointments %}
              <tr>
                  <td>{{ a.id }}</td>
                  <td>{{ a.doctor.name }}</td>
                  <td>{{ a.patient.name }}</td>
                  <td>{{ a.date }}</td>
                  <td>{{ a.time.strftime('%H:%M') }}</td>

                  <td class="status-cell"
                      data-date="{{ a.date }}"
                      data-time="{{ a.time.strftime('%H:%M') }}"
                      data-status="{{ a.status }}">
                      {% if a.status == "Booked" %}
                        <span class="badge bg-info text-dark">Booked</span>
                      {% elif a.status == "Completed" %}
                        <span class="badge bg-success">Completed</span>
                      {% elif a.status == "Cancelled" %}
                        <span class="badge bg-danger">Cancelled</span>
                      {% else %}
                        <span class="badge bg-secondary">{{ a.status }}</span>
                      {% endif %}
                  </td>
              </tr>
              {% endfor %}
          </tbody>

      </table>
  </div>

  <!-- SEARCH LOGIC -->
  <script>
    const searchBox = document.getElementById("searchBox");
    const tableBody = document.getElementById("appointmentsTable");

    searchBox.addEventListener("input", async () => {
      const q = searchBox.value.trim();

      if (q === "") {
        location.reload();
        return;
      }

      const res = await fetch(`/admin/search_appointments?q=${q}`);
      const data = await res.json();

      tableBody.innerHTML = data.map(a => `
        <tr>
          <td>${a.id}</td>
          <td>${a.doctor}</td>
          <td>${a.patient}</td>
          <td>${a.date}</td>
          <td>${a.time}</td>
          <td>${a.status}</td>
        </tr>
      `).join("");
    });
  </script>

  <!-- AUTO-MARK MISSED -->
  <script>
    document.querySelectorAll(".status-cell").forEach(cell => {
      const dateStr = cell.dataset.date;
      const timeStr = cell.dataset.time;
      const status  = cell.dataset.status;

      if (status !== "Booked") return;

      const apptTime = new Date(dateStr + "T" + timeStr + ":00");
      const now = new Date();

      if (apptTime < now) {
        cell.innerHTML = `<span class="badge bg-warning text-dark">Missed</span>`;
      }
    });
  </script>

</div>
</body>
</html>
