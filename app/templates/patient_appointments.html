<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>My Appointments</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-4">
  <h2 class="text-primary mb-3">My Appointments</h2>
  <a href="{{ url_for('patient_dashboard') }}" class="btn btn-secondary mb-3">Back to Dashboard</a>

  <!-- Booking Form -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h4 class="card-title mb-3">Book a New Appointment</h4>

<form method="POST" id="appointmentForm">
    <div class="row g-3">

        <div class="col-md-4">
            <label class="form-label">Doctor:</label>
            <select name="doctor_id" id="doctorSelect" class="form-select" required>
                <option value="">-- Select Doctor --</option>
                {% for doctor in doctors %}
                    <option value="{{ doctor.id }}">{{ doctor.name }} ({{ doctor.department.name if doctor.department else 'N/A' }})</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-4">
            <label class="form-label">Date:</label>
            <input type="date" name="date" id="dateSelect" class="form-control" required>
        </div>

        <div class="col-md-4">
            <label class="form-label">Time:</label>
            <select name="time" id="timeSelect" class="form-select" required>
                <option value="">-- Select Time --</option>
            </select>
        </div>

        <div class="col-12">
            <button type="submit" class="btn btn-primary">Book Appointment</button>
        </div>

    </div>
</form>

<!-- Availability Script -->
<script>
    const availabilities = {{ availabilities | tojson }};
    const bookedSlots = {{ booked_slots | tojson }};

    const doctorSelect = document.getElementById("doctorSelect");
    const dateSelect = document.getElementById("dateSelect");
    const timeSelect = document.getElementById("timeSelect");

    function loadTimes() {
        const doctorId = doctorSelect.value;
        const date = dateSelect.value;
        timeSelect.innerHTML = '<option value="">-- Select Time --</option>';

        if (!doctorId || !date) return;

        const available = availabilities.find(a => 
            a.doctor_id == doctorId && a.date === date
        );

        if (!available) {
            const opt = document.createElement("option");
            opt.textContent = "No availability for this date";
            opt.disabled = true;
            timeSelect.appendChild(opt);
            return;
        }

        const start = available.start_time.slice(0,5);
        const end = available.end_time.slice(0,5);

        const bookedTimes = bookedSlots
            .filter(b => b.doctor_id == doctorId && b.date === date)
            .map(b => b.time);

        let [sh, sm] = start.split(':').map(Number);
        let [eh, em] = end.split(':').map(Number);
        let availableCount = 0;

        while (sh < eh || (sh === eh && sm < em)) {
            const hh = String(sh).padStart(2, '0');
            const mm = String(sm).padStart(2, '0');
            const timeStr = `${hh}:${mm}`;

            const opt = document.createElement("option");
            opt.value = timeStr;
            opt.textContent = timeStr;

            if (bookedTimes.includes(timeStr)) {
                opt.disabled = true;
                opt.textContent += " (Booked)";
            } else {
                availableCount++;
            }

            timeSelect.appendChild(opt);

            sm += 30;
            if (sm >= 60) { sm -= 60; sh++; }
        }

        if (availableCount === 0) {
            const opt = document.createElement("option");
            opt.textContent = "No slots available";
            opt.disabled = true;
            timeSelect.innerHTML = '';
            timeSelect.appendChild(opt);
        }
    }

    doctorSelect.addEventListener("change", loadTimes);
    dateSelect.addEventListener("change", loadTimes);
</script>

<!-- Restrict Date: Today + Next 6 Days -->
<script>
    const dateInput = document.getElementById("dateSelect");

    const today = new Date();
    const maxDate = new Date();
    maxDate.setDate(today.getDate() + 6);

    const pad = n => String(n).padStart(2, '0');

    const todayStr =
      `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;

    const maxDateStr =
      `${maxDate.getFullYear()}-${pad(maxDate.getMonth()+1)}-${pad(maxDate.getDate())}`;

    dateInput.min = todayStr;
    dateInput.max = maxDateStr;
</script>

    </div>
  </div>

  <!-- Appointment List -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h4 class="card-title mb-3">Your Appointments</h4>

      {% if appointments %}
      <table class="table table-striped table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Doctor</th>
            <th>Date</th>
            <th>Time</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>

        <tbody>
          {% for a in appointments %}
          <tr>
            <td>{{ a.id }}</td>
            <td>{{ a.doctor.name }}</td>
            <td>{{ a.date }}</td>
            <td>{{ a.time.strftime('%H:%M') }}</td>

            <!-- Status Cell -->
            <td class="status-cell"
                data-date="{{ a.date }}"
                data-time="{{ a.time.strftime('%H:%M') }}"
                data-status="{{ a.status }}">
              {% if a.status == 'Booked' %}
                <span class="badge bg-success">Booked</span>
              {% elif a.status == 'Cancelled' %}
                <span class="badge bg-danger">Cancelled</span>
              {% elif a.status == 'Completed' %}
                <span class="badge bg-primary">Completed</span>
              {% else %}
                <span class="badge bg-secondary">{{ a.status }}</span>
              {% endif %}
            </td>

            <!-- Cancel Button -->
            <td class="action-cell">
              {% if a.status == 'Booked' %}
                <a href="{{ url_for('cancel_appointment', appointment_id=a.id) }}" 
                   class="btn btn-sm btn-outline-danger cancel-btn">Cancel</a>
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>

          </tr>
          {% endfor %}
        </tbody>

      </table>

      {% else %}
        <p class="text-muted">You have no appointments yet.</p>
      {% endif %}

    </div>
  </div>

</div>

<!-- Auto-Mark Missed + Disable Cancel -->
<script>
    document.querySelectorAll(".status-cell").forEach(cell => {
        const dateStr = cell.dataset.date;
        const timeStr = cell.dataset.time;
        const status = cell.dataset.status;

        if (status !== "Booked") return;

        const apptDateTime = new Date(dateStr + "T" + timeStr + ":00");
        const now = new Date();

        if (apptDateTime < now) {
            // Set status badge
            cell.innerHTML = `<span class="badge bg-warning text-dark">Missed</span>`;

            // Disable cancel button for missed appointments
            const actionCell = cell.parentElement.querySelector(".action-cell");
            if (actionCell) {
                actionCell.innerHTML = `<span class="text-muted">-</span>`;
            }
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
